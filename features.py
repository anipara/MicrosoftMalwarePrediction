#!/usr/bin/env python3

import sys
import zipfile
import csv
import codecs
from copy import deepcopy
from json import dump

STRLABELS = [
    'ProductName',
    'EngineVersion',
    'AppVersion',
    'AvSigVersion',
    'Platform',
    'Processor',
    'OsVer',
    'OsPlatformSubRelease',
    'OsBuildLab',
    'SkuEdition',
    'PuaMode',
    'Census_MDC2FormFactor',
    'Census_DeviceFamily',
    'Census_PrimaryDiskTypeName',
    'Census_ChassisTypeName',
    'Census_PowerPlatformRoleName',
    'Census_OSVersion',
    'Census_OSArchitecture',
    'Census_OSBranch',
    'Census_OSEdition',
    'Census_OSSkuName',
    'Census_OSInstallTypeName',
    'Census_OSWUAutoUpdateOptionsName',
    'Census_GenuineStateName',
    'Census_ActivationChannel',
    'Census_FlightRing'
]

def features(zf, cf):
    with zipfile.ZipFile(zf, mode='r', allowZip64=True) as zdatafile:
        with zdatafile.open(cf, mode='r') as rawfile:
            rawdata = csv.reader(codecs.iterdecode(rawfile, 'utf-8'))
            labels = []
            identified = {}
            for lbl in STRLABELS:
                identified[lbl] = []
            for row in rawdata:
                if labels == []:
                    labels = deepcopy(row)
                else:
                    for i in range(len(row)):
                        if labels[i] in STRLABELS:
                            if row[i] not in identified[labels[i]]:
                                identified[labels[i]].append(row[i])
            with open('string_features.json', 'w') as output:
                dump(identified, output, indent=4)

if __name__ == '__main__':
    try:
        zfile = sys.argv[1]
        tfile = sys.argv[2]
    except IndexError:
        sys.stderr.write('training ZIP file needed with the inner file name:\r\nfeatures.py ZIPFILE CSVFILE\r\n')
    features(zfile, tfile)
